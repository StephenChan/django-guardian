---
name: Tests

on:
  push:
    branches:
      - master
      - devel
  pull_request:

jobs:
  tests:
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]
        django: ["5.0"]
        include:
          - os: "ubuntu-22.04"
          - os: "ubuntu-24.04"

    runs-on: ${{ matrix.os }}

    services:
      postgres:
        image: postgres:16.3
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install latest pip, setuptools, and wheel
        run: |
          python -m pip install --upgrade pip wheel setuptools
      - name: Install dependencies
        run: |
          PACKAGES=('mock' 'pytest' 'pytest-django' 'pytest-cov' 'django-environ' 'setuptools_scm' 'pyupgrade' 'psycopg2-binary')
          if [[ "${{ matrix.django }}" == 'main' ]]; then
              PACKAGES+=('https://github.com/django/django/archive/main.tar.gz');
          else
              PACKAGES+=("Django~=${{ matrix.django }}");
          fi;

          PGPASSWORD="postgres" psql -c 'create database django_guardian;' -h localhost -U postgres;
          PGPASSWORD="postgres" psql -c 'create database test_django_guardian;' -h localhost -U postgres;

          python -m pip install --upgrade --upgrade-strategy=only-if-needed ${PACKAGES[*]};
      - name: Ensure no version conflicts exist
        run: pip check
      - name: Lint modern PY3 syntax
        run: find . -name '*.py' | xargs pyupgrade --py3-only

      - name: Code tests (with PostgreSQL)
        run: |
          export DATABASE_URL=postgres://postgres:postgres@localhost/django_guardian
          python ./setup.py --version
          py.test guardian/testapp/tests/test_mixins.py::TestViewMixins::test_list_permission --cov=guardian
          cat database.log
